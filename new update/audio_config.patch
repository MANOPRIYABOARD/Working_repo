From 88b1f26dece92832fa84733018cd52c215feaf23 Mon Sep 17 00:00:00 2001
From: Mathanraj <mathan.raj@seco.com>
Date: Thu, 13 Jul 2017 12:18:59 +0530
Subject: [PATCH] Selecting dynamic choice in audio codec for
 ac97_standard/sgtl5000 in SECO CONFIG

---
 common/cmd_seco_config.c | 97 +++++++++++++++++++++++++++++++++++++++++++++++-
 1 file changed, 96 insertions(+), 1 deletion(-)

diff --git a/common/cmd_seco_config.c b/common/cmd_seco_config.c
index bab5fe3..391bc30 100755
--- a/common/cmd_seco_config.c
+++ b/common/cmd_seco_config.c
@@ -157,7 +157,7 @@
 
 #if defined CONFIG_TARGET_MX6SECO_Q7_928 || CONFIG_TARGET_MX6SECO_UQ7_962 || CONFIG_TARGET_MX6SECO_UQ7_J_A75
 #define BOOTARGS_BASE       \
-	"setenv bootargs ${console_interface} ${memory} ${cpu_freq} ${videomode} ${serial_dev}"
+	"setenv bootargs ${console_interface} ${memory} ${cpu_freq} ${videomode} ${serial_dev} ${audio_codec}"
 #else
 #define BOOTARGS_BASE       \
 	"setenv bootargs ${console_interface} ${memory} ${cpu_freq} ${videomode}"
@@ -543,6 +543,27 @@ static serial_mode_t serial_mode_list [] = {
     { "FLEXCAN",		 	-1,  0,  SERIAL_DEV_PRIMARY_FLEXCAN },
     { "UART",           	 	 0, -1,  SERIAL_DEV_PRIMARY_UART },
 };
+
+ /*  ___________________________________________________________________________
+  * |				AUDIO_CODEC SPECIFICATION		       /
+    /__________________________________________________________________________|
+ */
+
+#define AUDIO_CODEC_PRIMARY_AC97_STANDARD       	1
+#define AUDIO_CODEC_PRIMARY_SGTL5000	        	2
+
+typedef struct codec_mode {
+    char *label;
+    int codec_ac97_standard;
+    int codec_sgtl5000;
+    int primary;
+} codec_mode_t;
+
+static codec_mode_t codec_mode_list [] = {
+    { "SGTL5000 AUDIO",		 		-1,  0,  AUDIO_CODEC_PRIMARY_SGTL5000 },
+    { "AC97_Standard ",		           	 0, -1,  AUDIO_CODEC_PRIMARY_AC97_STANDARD },
+};
+
 #endif
 
 /*  __________________________________________________________________________
@@ -1081,6 +1102,33 @@ do {
 
     return selection;
 }
+
+/*  __________________________________________________________________________
+ * |                                                                          |
+ * |                         AUDIO_CODEC Setting Selection                    |
+ * |__________________________________________________________________________|
+ */
+
+int selection_codec_mode(codec_mode_t  codec_mode_list[], int num_element) {
+    char ch;
+    int i, selection = 0;
+
+do {
+        printf ("\n __________________________________________________");
+        printf ("\n               Choose AUDIO_CODEC Setting.\n");
+        printf (" __________________________________________________\n");
+        for ( i = 0 ; i < num_element ; i++ ) {
+            printf ("%d) %s\n", i+1, codec_mode_list[i].label);
+        }
+        printf ("> ");
+        ch = getc ();
+        printf ("%c\n", ch);
+    } while ((ctoi(ch) < 1) || (ctoi(ch) > num_element));
+
+    selection = ctoi(ch) - 1;
+
+    return selection;
+}
 #endif
 
 /*  __________________________________________________________________________
@@ -1211,6 +1259,13 @@ static int do_seco_config (cmd_tbl_t *cmdtp, int flag, int argc, char * const ar
 	char serial_flexcan_dev[80];
 	char serial_mode[300];
 
+	/*  for audio_codec  */
+	int set_audio_codec = 0;
+	int codec_mode_selection;
+	char codec_ac97_standard_audio[80];
+	char codec_sgtl5000_audio[80];
+	char codec_mode[300];
+
 #endif
 
 	if (argc > 2)
@@ -1252,6 +1307,10 @@ static int do_seco_config (cmd_tbl_t *cmdtp, int flag, int argc, char * const ar
 			set_serial_dev = 1;
 		}
 
+		if (strcmp(argv[1], "audio_codec") ==0) {
+			set_audio_codec = 1;
+		}
+
 #endif
 
 	}
@@ -1265,6 +1324,7 @@ static int do_seco_config (cmd_tbl_t *cmdtp, int flag, int argc, char * const ar
 		set_video = 1;
 #if defined CONFIG_TARGET_MX6SECO_Q7_928 || CONFIG_TARGET_MX6SECO_UQ7_962 || CONFIG_TARGET_MX6SECO_UQ7_J_A75
 		set_serial_dev = 1;
+		ser_audio_codec = 1;
 #endif
 	}
 
@@ -1460,6 +1520,40 @@ static int do_seco_config (cmd_tbl_t *cmdtp, int flag, int argc, char * const ar
 		setenv ("serial_dev", serial_mode);
 	} 
 
+	/*  ________________________________________________________________________________
+	 * |_____________________________ AUDIO_CODEC SETTING ______________________________|
+	 */
+
+	if ( set_audio_codec ) {
+			codec_mode_selection =  selection_codec_mode (codec_mode_list,
+					ARRAY_SIZE(codec_mode_list));	
+
+		if ( codec_mode_list [codec_mode_selection].codec_ac97_standard >= 0 ) {
+			sprintf (codec_ac97_standard_audio, "audio_codec=ac97_standard");
+
+	
+		} else
+			sprintf (codec_ac97_standard_audio, " ");
+
+		if (codec_mode_list [codec_mode_selection].codec_sgtl5000 >= 0 ) {
+			sprintf (codec_sgtl5000_audio, "audio_codec=sgtl5000");
+
+		} else
+			sprintf (codec_sgtl5000_audio, " ");
+		
+		sprintf (codec_mode, "%s %s", codec_ac97_standard_audio, codec_sgtl5000_audio);
+
+		if (strcmp (codec_ac97_standard_audio, " ") ) {
+			setenv ("codec_ac97_standard", codec_ac97_standard_audio);
+		}
+		
+		if (strcmp (codec_sgtl5000_audio, " ") ) {
+			setenv ("codec_sgtl5000", codec_sgtl5000_audio);
+		}
+
+		setenv ("audio_codec", codec_mode);
+	} 
+
 #endif
 
 	/*  __________________________________________________________________________
@@ -1544,5 +1638,6 @@ U_BOOT_CMD(
 	"seco_config [video]   - set video usage mode\n"
 #if defined CONFIG_TARGET_MX6SECO_Q7_928 || CONFIG_TARGET_MX6SECO_UQ7_962 || CONFIG_TARGET_MX6SECO_UQ7_J_A75
 	"seco_config [serial_dev] - select the serial_dev function.\n"
+	"seco_config [audio_codec] - select the audio_codec function.\n"
 #endif
 );
-- 
2.0.4


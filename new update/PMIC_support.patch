From fa1b5e5635b4bc73b5b723d03360c8873d3acc7c Mon Sep 17 00:00:00 2001
From: Mathanraj <mathan.raj@seco.com>
Date: Fri, 23 Jun 2017 11:11:46 +0530
Subject: [PATCH] Added PMIC support

---
 board/seco/SBC_984/mx6seco_984.c  | 87 +++++++++++++++++++--------------------
 include/configs/mx6seco_SBC_984.h | 23 ++++++-----
 2 files changed, 56 insertions(+), 54 deletions(-)

diff --git a/board/seco/SBC_984/mx6seco_984.c b/board/seco/SBC_984/mx6seco_984.c
index 5955f24..b6f9d67 100755
--- a/board/seco/SBC_984/mx6seco_984.c
+++ b/board/seco/SBC_984/mx6seco_984.c
@@ -13,8 +13,6 @@
 #define MX6_GPIO_BOOT_VALIDATE    IMX_GPIO_NR(2, 4)
 
 
-
-
 /* I2C1 - Embedded Controller */
 struct i2c_pads_info i2c_pad_info0 = {
 	.scl = {
@@ -258,44 +256,49 @@ int board_ehci_power (int port, int on) {
  * |__________________________________________________________________________|
  */
 
+
+/*
+ * Do not overwrite the console
+ * Use always serial for U-Boot console
+ */
+int overwrite_console (void) {
+	return 1;
+}
+
 #ifdef CONFIG_SECO_BOARD_NAME
 char *board_name = CONFIG_SECO_BOARD_NAME;
 #else
 char *board_name = "Seco SBC-i.MX6  - 984";
 #endif
 
+int board_early_init_f (void) {
 
-int board_init (void) {
-	/* address of boot parameters */
-	gd->bd->bi_boot_params = PHYS_SDRAM + 0x100;
-
-	boot_validate (MX6_GPIO_BOOT_VALIDATE, gpio_boot_validate_pad);
+	setup_iomux_uart();
 
-	print_boot_device ();
+#if defined(CONFIG_VIDEO_IPUV3)
+	setup_display();
+#endif
 
 	return 0;
 }
-/*  __________________________________________________________________________
- * |__________________________________________________________________________|
- */
-
 
+#define I2C_PMIC                                 0x1
 
-/*
- * Do not overwrite the console
- * Use always serial for U-Boot console
- */
-int overwrite_console (void) {
-	return 1;
-}
-
+#ifdef CONFIG_SYS_I2C_MXC
+	static struct pmic *pfuze;
+#endif
 
+int board_init (void) {
 
-int board_early_init_f (void) {
-	setup_iomux_uart();
-#if defined(CONFIG_VIDEO_IPUV3)
-	setup_display();
+#ifdef CONFIG_SYS_I2C_MXC
+	int s, i;
+	u8 *boardrev = NULL;
 #endif
+	
+	/* address of boot parameters */
+	gd->bd->bi_boot_params = PHYS_SDRAM + 0x100;
+
+	boot_validate (MX6_GPIO_BOOT_VALIDATE, gpio_boot_validate_pad);
 
 #ifdef CONFIG_SYS_USE_SPINOR
 	setup_spinor();
@@ -305,11 +308,24 @@ int board_early_init_f (void) {
 	setup_sata();
 #endif
 
-	return 0;
-}
-
+#ifdef CONFIG_SYS_I2C_MXC
+	s = get_seco_board_revision(&i2c_pad_info0, &boardrev);
+	for ( i = 0 ; i < s ; i++ )
+		gd->bd->board_revision[i] = boardrev[i];
 
+	printf ("ID: 9%X, rev %c%X\n", gd->bd->board_revision[1],
+		((gd->bd->board_revision[0] & 0xF0) >> 4) + 'a',
+		(gd->bd->board_revision[0] & 0x0F));
+	
+	setup_i2c (I2C_PMIC, CONFIG_SYS_I2C_SPEED, 0x7f, &i2c_pad_info1);
+	pfuze = pfuze_common_init(I2C_PMIC);
+       
+#endif
+	
+	print_boot_device ();
 
+	return 0;
+}
 
 #ifdef CONFIG_CMD_BMODE
 static const struct boot_mode board_boot_modes[] = {
@@ -319,29 +335,13 @@ static const struct boot_mode board_boot_modes[] = {
 };
 #endif
 
-
-
 int board_late_init (void) {
 	int ret = 0;
-#ifdef CONFIG_SYS_I2C_MXC
-	int s, i;
-	unsigned char *boardrev = NULL;
-#endif
 
 #ifdef CONFIG_CMD_BMODE
 	add_board_boot_modes(board_boot_modes);
 #endif
 
-#ifdef CONFIG_SYS_I2C_MXC
-	s = get_seco_board_revision(&i2c_pad_info0, boardrev);
-	for ( i = 0 ; i < s ; i++ )
-		gd->bd->board_revision[i] = boardrev[i];
-
-	printf ("dav 0-1  %#X   %#X\n", gd->bd->board_revision[0], gd->bd->board_revision[1]);
-	printf ("dav 2-3  %#X   %#X\n", gd->bd->board_revision[2], gd->bd->board_revision[3]);
-       
-#endif
-
 #ifdef CONFIG_PFUZE100_PMIC_I2C
 	ret = setup_pmic_voltages(&i2c_pad_info1);
 	if (ret)
@@ -356,7 +356,6 @@ int board_late_init (void) {
 }
 
 
-
 static void setup_pcie(void)
 {
 	
diff --git a/include/configs/mx6seco_SBC_984.h b/include/configs/mx6seco_SBC_984.h
index 6d4915e..6f1a45a 100755
--- a/include/configs/mx6seco_SBC_984.h
+++ b/include/configs/mx6seco_SBC_984.h
@@ -38,6 +38,13 @@
 #define CONFIG_SYS_USE_ETHERNET
 #define CONFIG_ENV_IS_IN_MMC
 
+/*  SECO COMPILATION MODULES */
+#define CONFIG_SECO_COMMON_BOARD                 1
+#define CONFIG_SECO_COMMON_USDHC                 1
+#define CONFIG_SECO_COMMON_RGMII                 1
+#define CONFIG_SECO_COMMON_RMII                  0
+#define CONFIG_SECO_COMMON_PFUZE                 1
+#define CONFIG_SECO_COMMON_DISPLAY               0
 
 
 /* Boot device:
@@ -45,7 +52,7 @@
  * 	external SD
  * 	SPI Flash
  */
-#define SECO_NUM_BOOT_DEV 1
+#define SECO_NUM_BOOT_DEV			2
 
 
 /* ____________________________________________________________________________
@@ -87,18 +94,15 @@
 	#define CONFIG_SYS_I2C_BASE                   I2C1_BASE_ADDR
 	#define CONFIG_SYS_I2C_SPEED                  100000
 
-
 	/* PMIC */
-	#define CONFIG_PFUZE100_PMIC_I2C
-	#ifdef CONFIG_PFUZE100_PMIC_I2C
-		#define CONFIG_PMIC_I2C_BUS		1
-		#define CONFIG_PMIC_I2C_SLAVE		0x8
-	#endif
+	#define CONFIG_POWER
+	#define CONFIG_POWER_I2C
+	#define CONFIG_POWER_PFUZE100
+	#define CONFIG_POWER_PFUZE100_I2C_ADDR       0x08
 
 #endif
 
 
-
 /* ____________________________________________________________________________
   |                                                                            |
   |                                     SATA                                   |
@@ -171,10 +175,9 @@
 
 
 #define CONFIG_BOOT_ID_EMMC     0
-//#define CONFIG_BOOT_ID_EXT_SD   1
 
 #define CONFIG_ROOT_ID_EMMC     0
-//#define CONFIG_ROOT_ID_EXT_SD   1
+
 
 
 #define CONFIG_MMCROOT			"/dev/mmcblk0p2"  /* SDHC4 */
-- 
2.0.4

